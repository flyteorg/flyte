syntax = "proto3";

package flyteidl2.workflow;

import "buf/validate/validate.proto";
import "flyteidl2/common/identifier.proto";
import "flyteidl2/workflow/queue_service.proto";
import "flyteidl2/workflow/run_definition.proto";
import "flyteidl2/workflow/state_service.proto";

option go_package = "github.com/flyteorg/flyte/v2/gen/go/flyteidl2/workflow";

// ActionsService provides an interface for managing the state and execution of actions.
// This service is intended to replace StateService and QueueService, providing a single interface for managing both
// the state and execution of actions.
service ActionsService {
  // UpdateActionStatus updates the status of an action and saves serialized NodeStatus.
  // This deprecates Put in the current StateService.
  rpc UpdateActionStatus(UpdateActionStatusRequest) returns (UpdateActionStatusResponse) {}

  // GetActionState returns the `NodeStatus` of an action.
  // This deprecates Get in the current StateService.
  rpc GetActionState(GetActionStateRequest) returns (GetActionStateResponse) {}

  // EnqueueAction queues a new action for execution.
  rpc EnqueueAction(flyteidl2.workflow.EnqueueActionRequest) returns (flyteidl2.workflow.EnqueueActionResponse) {}

  // AbortQueuedAction aborts a single action that was previously queued or is currently being processed by a worker.
  // Note that this will cascade aborts to all descendant actions of the specified action.
  rpc AbortQueuedAction(flyteidl2.workflow.AbortQueuedActionRequest) returns (flyteidl2.workflow.AbortQueuedActionResponse) {}

  // Watch watches for updates to the state of actions.
  // This API guarantees at-least-once delivery semantics.
  rpc Watch(flyteidl2.workflow.WatchRequest) returns (stream flyteidl2.workflow.WatchResponse) {}
}

// ============================================================================
// UpdateActionStatus
// ============================================================================

// UpdateActionStatusRequest is the request message for updating the status of an action.
message UpdateActionStatusRequest {
  // A unique identifier for the action.
  flyteidl2.common.ActionIdentifier action_id = 1 [(buf.validate.field).required = true];

  // The attempt number (starts at 1, incremented on retry).
  uint32 attempt = 2;

  // The new status of the action.
  flyteidl2.workflow.ActionStatus status = 3 [(buf.validate.field).required = true];

  // The new state in form of a JSON serialized `NodeStatus` object.
  string state = 4 [(buf.validate.field).string.min_len = 2];
}

// UpdateActionStatusResponse is the response message for updating the status of an action.
message UpdateActionStatusResponse {}

// ============================================================================
// GetActionState
// ============================================================================

// GetActionStateRequest is the request message for getting the state of an action.
message GetActionStateRequest {
  // A unique identifier for the action.
  flyteidl2.common.ActionIdentifier action_id = 1 [(buf.validate.field).required = true];

  // The attempt number (starts at 1, incremented on retry).
  uint32 attempt = 2;
}

// GetActionStateResponse is the response message for getting the state of an action.
message GetActionStateResponse {
  // A JSON serialized `NodeStatus` object.
  string state = 1 [(buf.validate.field).string.min_len = 1];
}
