name: Check Generated Files

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set fallback version
        run: echo "SETUPTOOLS_SCM_PRETEND_VERSION=0.0.0" >> $GITHUB_ENV
      - name: Set up the environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: '3.10'
          working-directory: './gen/python'
      - name: Setup Buf CLI
        uses: bufbuild/buf-setup-action@v1 # Install the Buf CLI
        with:
          version: 'latest' # Or specify a precise version like '1.56.0'
      - name: Run make generate
        run: make generate
      - name: Check for changes
        run: |
          git diff --exit-code || (echo 'Generated files are out of date. Run make generate and commit changes.' && exit 1)

